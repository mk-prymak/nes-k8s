apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-config
  namespace: nes
data:
  grafana.ini: |
    [auth.anonymous]
    enabled = true
    org_name = Main Org.
    org_role = Admin

    [users]
    default_theme = light

    [dashboards]
    default_home_dashboard_path = /var/lib/grafana/dashboards/icu-vitals-dashboard.json

  dashboards.yml: |
    apiVersion: 1
    providers:
      - name: 'ICU vitals dashboards'
        disableDeletion: false
        allowUiUpdates: true
        options:
          path: '/var/lib/grafana/dashboards'

  mqtt-datasource.yml: |
    apiVersion: 1
    datasources:
      - name: 'NES_MQTT'
        type: 'grafana-mqtt-datasource'
        isDefault: true
        editable: true
        version: 1
        jsonData:
          uri: "ws://mosquitto:9001"

  icu-vitals-dashboard.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "graphTooltip": 0,
      "panels": [
        {
          "type": "row",
          "title": "ICU vitals (MQTT JSON)",
          "gridPos": { "h": 1, "w": 24, "x": 0, "y": 0 },
          "id": 1,
          "collapsed": false,
          "panels": []
        },
        {
          "id": 2,
          "type": "table",
          "title": "Pulse (bpm)",
          "gridPos": { "h": 8, "w": 8, "x": 0, "y": 1 },
          "targets": [
            {
              "refId": "A",
              "topic": "icu/pulse",
              "datasource": { "type": "grafana-mqtt-datasource", "uid": "NES_MQTT" }
            }
          ]
        },
        {
          "id": 3,
          "type": "table",
          "title": "Blood pressure (systolic/diastolic)",
          "gridPos": { "h": 8, "w": 8, "x": 8, "y": 1 },
          "targets": [
            {
              "refId": "A",
              "topic": "icu/bloodPressure",
              "datasource": { "type": "grafana-mqtt-datasource", "uid": "NES_MQTT" }
            }
          ]
        },
        {
          "id": 4,
          "type": "table",
          "title": "SpOâ‚‚ (%)",
          "gridPos": { "h": 8, "w": 8, "x": 16, "y": 1 },
          "targets": [
            {
              "refId": "A",
              "topic": "icu/spo2",
              "datasource": { "type": "grafana-mqtt-datasource", "uid": "NES_MQTT" }
            }
          ]
        }
      ],
      "schemaVersion": 39,
      "tags": ["icu", "mqtt"],
      "templating": { "list": [] },
      "time": { "from": "now-5m", "to": "now" },
      "timezone": "browser",
      "title": "ICU vitals",
      "uid": "icu-vitals",
      "version": 1
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  namespace: nes
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      containers:
        - name: grafana
          image: grafana/grafana:latest
          env:
            - name: GF_INSTALL_PLUGINS
              value: "grafana-mqtt-datasource"
          ports:
            - containerPort: 3000
          volumeMounts:
            - name: grafana-config
              mountPath: /etc/grafana/grafana.ini
              subPath: grafana.ini
            - name: grafana-config
              mountPath: /etc/grafana/provisioning/dashboards/dashboards.yml
              subPath: dashboards.yml
            - name: grafana-config
              mountPath: /etc/grafana/provisioning/datasources/mqtt-datasource.yml
              subPath: mqtt-datasource.yml
            - name: grafana-config
              mountPath: /var/lib/grafana/dashboards/icu-vitals-dashboard.json
              subPath: icu-vitals-dashboard.json
      volumes:
        - name: grafana-config
          configMap:
            name: grafana-config
---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  namespace: nes
spec:
  selector:
    app: grafana
  ports:
    - name: http
      port: 3000
      targetPort: 3000
      nodePort: 30001
  type: NodePort
